Кодировка и импорты включают необходимые асинхронные библиотеки и модули проекта, такие как база данных, анализаторы и системные утилиты. Они обеспечивают базовые возможности для обработки диалогов и бизнес-логики, что критично для работы всего модуля.  

Класс BusinessConversation управляет состоянием и логикой диалога для сбора бизнес-данных. Он определяет этапы взаимодействия через STATES, списки обязательных и опциональных полей данных, а также хранит контекст сессии. Это сердце модуля, обеспечивающее структурированное взаимодействие с пользователем.  

Метод initialize создает новую сессию в базе данных при старте диалога. Он назначает пользователя и начальное состояние, обеспечивая отслеживание диалога и сохранение прогресса. Важен для правильной инициализации сессии.  

Метод process_message обрабатывает входящие сообщения пользователя на основе текущего состояния сессии. В нем определяется выход из диалога, вызываются соответствующие обработчики состояний и формируется ответ. Ключевой метод, связывающий логику диалога с пользовательским вводом.  

Метод _handle_data_collection управляет этапом свободного ввода данных. Он вызывает AI-функции для извлечения и дополнения данных, проверяет полноту информации, определяет недостающие поля и готовит пользовательские подсказки. Центральный элемент для сбора и объединения бизнес-метрик.  

Метод _get_data_summary генерирует читаемую сводку собранных данных. Он форматирует числовые и текстовые значения, выделяет отсутствующие поля и группирует информацию. Критически важен для отображения прогресса перед анализом.  

Метод _handle_analysis активирует бизнес-анализ при подтверждении пользователя. Он запускает систему анализа, обрабатывает результаты, форматирует финальный отчет и переводит сессию в завершенное состояние. Финализирует процесс сбора данных.  

Метод _format_analysis_response преобразует сырые данные анализа в понятный текстовый отчет. Используется для итоговых выводов системы и объединяет метрики с AI-рекомендациями. Обеспечивает понятное представление результатов для пользователя.  

Метод _has_required_data проверяет заполненность критических полей бизнес-информации. Он валидирует наличие названия и числовых данных, что гарантирует возможность базового анализа перед генерацией отчета.  

Метод _save_user_response записывает каждое сообщение пользователя в лог базы данных. Не публикует ошибки для сохранения плавного диалога. Обеспечивает трассируемость и возможность восстановления сессий.  

Метод _update_state изменяет текущий этап сессии и сохраняет его в базе данных. Синхронизирует состояние системы с хранилищем при каждом переходе. Основной механизм контроля статусов диалога.  

Класс ConversationManager хранит активные сессии в памяти для быстрого доступа. Обрабатывает создание, извлечение и завершение диалогов BusinessConversation по ID пользователя. Оптимизирует управление параллельными взаимодействиями.  

Глобальный экземпляр conv_manager инициализирует менеджер сессий при старте модуля. Предоставляет единую точку доступа к управлению диалогами во всем приложении. Критичен для работы с несколькими пользователями одновременно.