Функция импорта библиотек и настройки логирования включает необходимые модули для работы ИИ, регулярных выражений, журналирования и асинхронных операций. Настраивает базовую конфигурацию логирования для записи временных меток, уровней и сообщений, что важно для отслеживания работы системы в реальном времени.

Глобальная память и установка модели инициализирует словарь conversation_memory для хранения истории диалогов между пользователем и ботом. Определяет SIMPLE_MODEL как стандартную модель GPT-4 для обработки запросов, обеспечивая основу для генерации ответов.

Промпт классификатора сообщений содержит инструкции для ИИ по категоризации входящих текстов строго в три типа: BUSINESS_DATA, BUSINESS_QUESTION или GENERAL_CHAT. Четкие правила классификации по ключевым словам и цифрам позволяют системе корректно направлять запросы в соответствующие обработчики.

Промпт извлечения бизнес-данных задает алгоритм для преобразования неструктурированного текста в форматированный JSON. Исключает произвольные комментарии и гарантирует преобразование числовых сокращений, что критично для последующего анализа метрик.

Промпт анализа недостающих данных генерирует уточняющие вопросы на основе текущего набора данных. Жесткие правила приоритезируют запрос критических показателей, предотвращают дублирование вопросов и автоматически завершают сбор при полноте информации.

Промпты ответов на вопросы и общего чата определяют ролевые модели поведения ИИ: как эксперта-консультанта для бизнес-вопросов и дружелюбного собеседника для неформального общения. Это обеспечивает контекстно-зависимое взаимодействие с пользователем.

Функция classify_message_type асинхронно определяет тип сообщения с помощью ИИ, используя классификатор с резервной эвристикой. Стратегия fallback на поиск цифр и бизнес-терминов гарантирует работу при сбоях ИИ, поддерживая надежность классификации.

Функция simple_detect_message_type реализует резервную логику категоризации через ключевые слова и числовые паттерны. Это критично для поддержания базовой функциональности при недоступности основной модели ИИ.

Функция extract_business_data асинхронно преобразует текстовое описание бизнеса в структурированный JSON. Регулярные выражения извлекают валидные данные из ответа ИИ, обеспечивая совместимость с системой анализа.

Функция analyze_missing_data проверяет полноту бизнес-метрик, исключая невалидные значения. На основе пробелов генерирует минимальное количество уточняющих вопросов или сигнализирует о готовности к анализу.

Функция prepare_messages собирает историю диалога, добавляя системные промпты перед пользовательским запросом. Ограничение истории 12 сообщениями предотвращает перегрузку контекста модели ИИ.

Функция answer_question использует историю диалога и экспертный промпт для генерации бизнес-советов. Сохранение сессии в conversation_memory обеспечивает контекстную преемственность.

Функция general_chat обрабатывает неформальные запросы, поддерживая легкую беседу и осторожно предлагая бизнес-анализ. Сохранение истории аналогично answer_question обеспечивает согласованность взаимодействия.

Тестовый блок проверяет извлечение данных, отображая результат парсинга тестового текста. Это позволяет оперативно диагностировать работоспособность ключевой функции перед развертыванием.