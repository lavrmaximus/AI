{% extends "base.html" %}

{% block title %}–¶–µ–ª–∏ –∏ –ó–∞–¥–∞—á–∏ - BusinessAI{% endblock %}

{% block content %}
<div class="goals-header">
    <h1>–¶–µ–ª–∏ –∏ –ó–∞–¥–∞—á–∏</h1>
    <div class="user-selector">
        <label for="userSelect">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
        <select id="userSelect" onchange="loadUserGoals()">
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
        </select>
    </div>
</div>

<div class="goals-stats">
    <div class="stat-card">
        <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏</h3>
        <div class="stat-value" id="active-goals">0</div>
    </div>
    <div class="stat-card">
        <h3>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</h3>
        <div class="stat-value" id="completed-goals">0</div>
    </div>
    <div class="stat-card">
        <h3>–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h3>
        <div class="stat-value" id="total-progress">0%</div>
    </div>
</div>

<div class="goals-filter">
    <button class="filter-btn active" onclick="filterGoals('all')">–í—Å–µ</button>
    <button class="filter-btn" onclick="filterGoals('active')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
    <button class="filter-btn" onclick="filterGoals('completed')">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
</div>

<div class="goals-container" id="goalsContainer">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–ª–µ–π...</div>
</div>

<script>
    let allGoals = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
    });

    async function loadUsers() {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            
            if (data.success) {
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>';
                
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    userSelect.appendChild(option);
                });
                
                if (data.users.length > 0) {
                    userSelect.value = data.users[0].id;
                    loadUserGoals();
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        }
    }

    async function loadUserGoals() {
        const userId = document.getElementById('userSelect').value;
        if (!userId) return;

        try {
            const response = await fetch(`/api/user-goals/${userId}`);
            const data = await response.json();
            
            if (data.success) {
                allGoals = data.goals;
                updateStats();
                renderGoals('all');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–ª–µ–π:', error);
        }
    }

    function updateStats() {
        const activeGoals = allGoals.filter(goal => goal.status === 'active').length;
        const completedGoals = allGoals.filter(goal => goal.status === 'completed').length;
        const totalProgress = allGoals.length > 0 ? 
            Math.round(allGoals.reduce((sum, goal) => sum + goal.progress_percentage, 0) / allGoals.length) : 0;

        document.getElementById('active-goals').textContent = activeGoals;
        document.getElementById('completed-goals').textContent = completedGoals;
        document.getElementById('total-progress').textContent = totalProgress + '%';
    }

    function filterGoals(status) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        renderGoals(status);
    }

    function renderGoals(filter) {
        const container = document.getElementById('goalsContainer');
        let filteredGoals = allGoals;

        if (filter === 'active') {
            filteredGoals = allGoals.filter(goal => goal.status === 'active');
        } else if (filter === 'completed') {
            filteredGoals = allGoals.filter(goal => goal.status === 'completed');
        }

        if (filteredGoals.length === 0) {
            container.innerHTML = '<div class="no-goals">–¶–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }

        container.innerHTML = filteredGoals.map(goal => `
            <div class="goal-card ${goal.status}">
                <div class="goal-header">
                    <h3>${goal.title}</h3>
                    <span class="goal-status ${goal.status}">${getStatusText(goal.status)}</span>
                </div>
                
                ${goal.description ? `<p class="goal-description">${goal.description}</p>` : ''}
                
                <div class="goal-progress">
                    <div class="progress-info">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å: ${goal.current_value}/${goal.target_value}</span>
                        <span>${goal.progress_percentage}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${goal.progress_percentage}%"></div>
                    </div>
                </div>
                
                <div class="goal-meta">
                    ${goal.category ? `<span class="goal-category">${goal.category}</span>` : ''}
                    ${goal.deadline ? `<span class="goal-deadline">üìÖ ${goal.deadline}</span>` : ''}
                </div>
                
                <div class="goal-actions">
                    ${goal.status === 'active' ? `
                        <button class="btn-update" onclick="showUpdateModal(${goal.id}, ${goal.target_value})">
                            –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
                        </button>
                        <button class="btn-complete" onclick="completeGoal(${goal.id})">
                            –ó–∞–≤–µ—Ä—à–∏—Ç—å
                        </button>
                    ` : ''}
                </div>
            </div>
        `).join('');
    }

    function getStatusText(status) {
        const statusMap = {
            'active': '–ê–∫—Ç–∏–≤–Ω–∞',
            'completed': '–í—ã–ø–æ–ª–Ω–µ–Ω–∞',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–∞'
        };
        return statusMap[status] || status;
    }

    function showUpdateModal(goalId, targetValue) {
        const newValue = prompt(`–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–º–∞–∫—Å–∏–º—É–º: ${targetValue}):`, '0');
        if (newValue !== null) {
            const value = parseInt(newValue);
            if (!isNaN(value) && value >= 0 && value <= targetValue) {
                updateGoalProgress(goalId, value);
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ');
            }
        }
    }

    async function updateGoalProgress(goalId, currentValue) {
        try {
            const response = await fetch('/api/update-goal-progress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    goal_id: goalId,
                    current_value: currentValue
                })
            });
            
            const data = await response.json();
            if (data.success) {
                loadUserGoals(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ–ª–∏
            } else {
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–ª–∏');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–ª–∏:', error);
            alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–ª–∏');
        }
    }

    async function completeGoal(goalId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —ç—Ç—É —Ü–µ–ª—å?')) {
            try {
                const response = await fetch('/api/complete-goal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        goal_id: goalId
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadUserGoals(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ–ª–∏
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ü–µ–ª–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ü–µ–ª–∏:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ü–µ–ª–∏');
            }
        }
    }
</script>
{% endblock %}