{% extends "base.html" %}

{% block title %}Аналитика - BusinessAI{% endblock %}

{% block content %}
<div class="analytics-header">
    <h1>Глубокая Аналитика</h1>
    <div class="enhanced-select" style="margin-top:10px;">
        <div class="dropdown-container" id="userSelectCustom">
            <button type="button" class="dropdown-button" id="userSelectTrigger">
                Выберите пользователя
            </button>
            <div class="dropdown-menu" id="userOptions"></div>
        </div>
        <select id="userSelect" onchange="loadUserData()" style="display:none;">
            <option value="">Выберите пользователя</option>
        </select>
    </div>
    
    <div class="enhanced-select" style="margin-top:10px;">
        <div class="dropdown-container" id="businessSelectCustom">
            <button type="button" class="dropdown-button" id="businessSelectTrigger">
                Выберите бизнес
            </button>
            <div class="dropdown-menu" id="businessOptions"></div>
        </div>
        <select id="businessSelect" onchange="loadBusinessData()" style="display:none;">
            <option value="">Выберите бизнес</option>
        </select>
    </div>
</div>

<div class="analytics-content">
    <div class="analytics-section">
        <h2>Детальный финансовый анализ</h2>
        <div id="financialAnalysis">
            <div class="loading">Загрузка финансового анализа...</div>
        </div>
    </div>
    
    <div class="analytics-section">
        <h2>Тренды и прогнозы</h2>
        <div id="trendsAnalysis">
            <div class="loading">Загрузка анализа трендов...</div>
        </div>
    </div>

    <div class="analytics-section">
        <h2>Советы для бизнеса</h2>
        <div id="adviceCard">
            <div class="loading">Загрузка советов...</div>
        </div>
    </div>

</div>

<script>
    let currentBusinessId = null;
    let currentUserId = null;

    // Загрузка информации о текущем пользователе при открытии страницы
    document.addEventListener('DOMContentLoaded', function() {
        const userIdFromUrl = '{{ user_id }}';
        loadUsers(userIdFromUrl);
    });

    async function loadCurrentUser(userId) {
        try {
            const response = await fetch(`/api/current-user/${userId}`);
            const data = await response.json();
            
            if (data.success) {
                const user = data.user;
                const displayName = user.first_name && user.last_name ? 
                    `${user.first_name} ${user.last_name}` : 
                    (user.first_name || user.username || `User ${user.user_id}`);
                
                document.getElementById('current-user-name').textContent = displayName;
                document.getElementById('user-info').style.display = 'block';
                
                // Загружаем бизнесы пользователя
                await loadUserBusinesses(userId);
            } else {
                console.error('User not found:', data.error);
            }
        } catch (error) {
            console.error('Error loading current user:', error);
        }
    }

    async function loadUserBusinesses(userId) {
        try {
            const response = await fetch(`/api/businesses/${userId}`);
            const data = await response.json();
            
            if (data.success && data.businesses.length > 0) {
                const businessSelect = document.getElementById('businessSelect');
                const bizTrigger = document.getElementById('businessSelectTrigger');
                const bizOptions = document.getElementById('businessOptions');
                
                businessSelect.innerHTML = '<option value="">Выберите бизнес</option>';
                while (bizOptions.firstChild) {
                    bizOptions.removeChild(bizOptions.firstChild);
                }
                
                data.businesses.forEach(b => {
                    const option = document.createElement('option');
                    option.value = b.business_id;
                    const bizName = (b && b.business_name) ? b.business_name : `Бизнес ${b && b.business_id ? b.business_id : ''}`;
                    option.textContent = bizName;
                    businessSelect.appendChild(option);
                    
                    const optDiv = document.createElement('div');
                    optDiv.className = 'dropdown-option';
                    optDiv.dataset.value = b.business_id;
                    optDiv.textContent = bizName;
                    optDiv.addEventListener('click', () => {
                        businessSelect.value = b.business_id;
                        bizTrigger.textContent = bizName;
                        closeCustomSelect('businessSelectCustom');
                        loadBusinessData();
                    });
                    bizOptions.appendChild(optDiv);
                });
                
                // Автоматически выбираем первый бизнес
                businessSelect.value = data.businesses[0].business_id;
                bizTrigger.textContent = (data.businesses[0] && data.businesses[0].business_name) ? 
                    data.businesses[0].business_name : `Бизнес ${data.businesses[0].business_id}`;
                currentBusinessId = data.businesses[0].business_id;
                await loadBusinessData();
            } else {
                bizTrigger.textContent = 'Нет бизнесов';
            }
        } catch (error) {
            console.error('Error loading user businesses:', error);
        }
    }

    async function loadUsers(userIdToSelect) {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            
            if (data.success) {
                const userSelect = document.getElementById('userSelect');
                const userTrigger = document.getElementById('userSelectTrigger');
                const userOptions = document.getElementById('userOptions');
                
                if (!userSelect || !userTrigger || !userOptions) {
                    console.error('User selector elements not found');
                    return;
                }
                
                userSelect.innerHTML = '<option value="">Выберите профиль</option>';
                userOptions.innerHTML = '';
                
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.user_id;
                    const displayName = user.first_name && user.last_name ? 
                        `${user.first_name} ${user.last_name}` : 
                        (user.first_name || user.username || `User ${user.user_id}`);
                    option.textContent = displayName;
                    userSelect.appendChild(option);
                    
                    const optDiv = document.createElement('div');
                    optDiv.className = 'dropdown-option';
                    optDiv.dataset.value = user.user_id;
                    optDiv.textContent = displayName;
                    optDiv.addEventListener('click', () => {
                        userSelect.value = user.user_id;
                        userTrigger.textContent = displayName;
                        closeCustomSelect('userSelectCustom');
                        loadUserData();
                    });
                    userOptions.appendChild(optDiv);
                });
                
                if (userIdToSelect) {
                    const userExists = data.users.some(user => user.user_id === userIdToSelect);
                    if (userExists) {
                        userSelect.value = userIdToSelect;
                        const selectedUser = data.users.find(user => user.user_id === userIdToSelect);
                        const displayName = selectedUser.first_name && selectedUser.last_name ? 
                            `${selectedUser.first_name} ${selectedUser.last_name}` : 
                            (selectedUser.first_name || selectedUser.username || `User ${selectedUser.user_id}`);
                        userTrigger.textContent = displayName;
                        loadUserData();
                    }
                } else if (data.users.length > 0) {
                    userSelect.value = data.users[0].user_id;
                    const firstUser = data.users[0];
                    const displayName = firstUser.first_name && firstUser.last_name ? 
                        `${firstUser.first_name} ${firstUser.last_name}` : 
                        (firstUser.first_name || firstUser.username || `User ${firstUser.user_id}`);
                    userTrigger.textContent = displayName;
                    loadUserData();
                } else {
                    userTrigger.textContent = 'Нет профилей';
                }
            }
        } catch (error) {
            console.error('Ошибка загрузки профилей:', error);
        }
    }

    async function loadUserData() {
        const userId = document.getElementById('userSelect').value;
        if (!userId) return;
        currentUserId = userId;
        await loadUserBusinesses(userId);
    }

    async function loadBusinessData() {
        const businessId = document.getElementById('businessSelect').value;
        if (!businessId) return;
        currentBusinessId = businessId;
        await loadFinancialAnalysis(currentBusinessId);
        await loadTrendsAnalysis(currentBusinessId);
        await loadChartsForAnalytics(currentBusinessId);
        await loadAdvice(currentBusinessId);
    }

    async function loadFinancialAnalysis(businessId) {
        try {
            const aiResponse = await fetch(`/api/business-ai-analysis/${businessId}`);
            const aiData = await aiResponse.json();
            
            if (aiData.success) {
                renderFinancialAnalysis(aiData.analysis);
            } else {
                const container = document.getElementById('financialAnalysis');
                container.innerHTML = `<p>Нет данных для анализа: ${aiData.error || 'сервер не вернул данные'}</p>`;
            }
        } catch (error) {
            console.error('Ошибка загрузки финансового анализа:', error);
            const container = document.getElementById('financialAnalysis');
            container.innerHTML = '<p>Ошибка загрузки финансового анализа. Повторите попытку позже.</p>';
        }
    }

    async function loadTrendsAnalysis(businessId) {
        try {
            const financeResponse = await fetch(`/api/business-history/${businessId}`);
            const financeData = await financeResponse.json();
            
            if (financeData.success) {
                renderTrendsAnalysis(financeData.data);
            } else {
                const container = document.getElementById('trendsAnalysis');
                container.innerHTML = `<p>Нет данных для анализа трендов: ${financeData.error || 'сервер не вернул данные'}</p>`;
            }
        } catch (error) {
            console.error('Ошибка загрузки анализа трендов:', error);
            const container = document.getElementById('trendsAnalysis');
            container.innerHTML = '<p>Ошибка загрузки анализа трендов. Повторите попытку позже.</p>';
        }
    }

    async function loadChartsForAnalytics(businessId) {
        try {
            const response = await fetch(`/api/business-history/${businessId}`);
            const data = await response.json();
            if (data.success) {
                window.currentChartData = data.data;
                if (!window.selectedMetrics || window.selectedMetrics.size === 0) {
                    window.selectedMetrics = new Set(['revenue','expenses','profit']);
                }
                renderFinanceChart(data.data);
            }
        } catch (error) {
            console.error('Ошибка загрузки графиков:', error);
        }
    }

    async function loadAdvice(businessId) {
        try {
            const resp = await fetch(`/api/business-advice/${businessId}`);
            const data = await resp.json();
            const card = document.getElementById('adviceCard');
            const section = card.closest('.analytics-section');
            
            if (data.success && data.advice && data.advice.length) {
                card.innerHTML = `
                    <div class="analysis-card">
                        <h4>💡 Советы ИИ</h4>
                        <ul>${data.advice.map(a => `<li>${a}</li>`).join('')}</ul>
                    </div>
                `;
                section.style.display = 'block';
            } else {
                // Скрываем всю секцию советов, если советов от ИИ нет
                section.style.display = 'none';
            }
        } catch (e) {
            const card = document.getElementById('adviceCard');
            const section = card.closest('.analytics-section');
            // Скрываем секцию при ошибке
            section.style.display = 'none';
        }
    }

    async function loadChartsForAnalytics(businessId) {
        try {
            const response = await fetch(`/api/business-history/${businessId}`);
            const data = await response.json();
            if (data.success) {
                // Используем ту же логику рендеринга графиков из dashboard
                window.currentChartData = data.data;
                if (!window.selectedMetrics || window.selectedMetrics.size === 0) {
                    window.selectedMetrics = new Set(['revenue','expenses','profit']);
                }
                renderFinanceChart(data.data);
            }
        } catch (error) {
            console.error('Ошибка загрузки графиков:', error);
        }
    }

    function renderFinancialAnalysis(analysis) {
        const container = document.getElementById('financialAnalysis');
        
        container.innerHTML = `
            <div class="analysis-card">
                <h4>Рентабельность бизнеса</h4>
                <div class="profitability-gauge">
                <div class="gauge-value">${Math.min(100, Math.max(0, analysis.metrics.profitability))}%</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" style="width: ${Math.min(100, Math.max(0, analysis.metrics.profitability))}%"></div>
                    </div>
                </div>
                <p>${analysis.summary}</p>
            </div>
            
            <div class="analysis-card">
                <h4>Оценка эффективности</h4>
                <div class="efficiency-score">${analysis.metrics.efficiency_score}/100</div>
                <p>Общая оценка эффективности бизнес-процессов</p>
            </div>
        `;
        
        // Добавляем карточку "Тренды и наблюдения" только если есть ai_commentary
        if (analysis.commentary && analysis.commentary.trim()) {
            container.innerHTML += `
                <div class="analysis-card">
                    <h4>🔍 Тренды и наблюдения</h4>
                    <p>${analysis.commentary}</p>
                </div>
            `;
        }
    }

    function renderTrendsAnalysis(data) {
        const container = document.getElementById('trendsAnalysis');
        
        if (data.series && data.series.revenue && data.series.revenue.length >= 2) {
            const revenueGrowth = ((data.series.revenue[0] - data.series.revenue[1]) / data.series.revenue[1] * 100).toFixed(1);
            const profitGrowth = ((data.series.profit[0] - data.series.profit[1]) / data.series.profit[1] * 100).toFixed(1);
            
            container.innerHTML = `
                <div class="trends-grid">
                    <div class="trend-card ${revenueGrowth >= 0 ? 'positive' : 'negative'}">
                        <h4>Рост выручки</h4>
                        <div class="trend-value">${revenueGrowth}%</div>
                    </div>
                    <div class="trend-card ${profitGrowth >= 0 ? 'positive' : 'negative'}">
                        <h4>Рост прибыли</h4>
                        <div class="trend-value">${profitGrowth}%</div>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = '<p>Недостаточно данных для анализа трендов</p>';
        }
    }

    // Функция экспорта графиков
    function exportChart(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            alert('График не найден');
            return;
        }
        
        const link = document.createElement('a');
        link.download = `chart-${canvasId}-${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    // Логика открытия/закрытия выпадающих меню
    document.addEventListener('click', function(e) {
        const userCustom = document.getElementById('userSelectCustom');
        const bizCustom = document.getElementById('businessSelectCustom');
        
        [userCustom, bizCustom].forEach((container, index) => {
            if (!container) return;
            
            const button = container.querySelector('.dropdown-button');
            const menu = container.querySelector('.dropdown-menu');
            
            if (!button || !menu) return;
            
            // Проверяем, что клик именно по кнопке, но не по меню внутри
            if (button.contains(e.target) && !menu.contains(e.target)) {
                container.classList.toggle('open');
            } else if (!container.contains(e.target)) {
                container.classList.remove('open');
            }
        });
    });

    function closeCustomSelect(id) {
        const container = document.getElementById(id);
        if (container) container.classList.remove('open');
    }
</script>
{% endblock %}