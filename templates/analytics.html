{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - BusinessAI{% endblock %}

{% block content %}
<div class="analytics-header">
    <h1>–ì–ª—É–±–æ–∫–∞—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
    <div class="user-selector">
        <label for="userSelect">üîç –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å:</label>
        <div class="enhanced-select">
            <div class="custom-select" id="userSelectCustom">
                <button type="button" class="custom-select-trigger" aria-haspopup="listbox" aria-expanded="false" id="userSelectTrigger">–ó–∞–≥—Ä—É–∑–∫–∞...</button>
                <div class="custom-options" role="listbox" id="userOptions"></div>
            </div>
            <select id="userSelect" onchange="loadUserData()" style="display:none;">
                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
            </select>
        </div>
        <div class="enhanced-select" style="margin-top:10px;">
            <div class="custom-select" id="businessSelectCustom">
                <button type="button" class="custom-select-trigger" aria-haspopup="listbox" aria-expanded="false" id="businessSelectTrigger">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å</button>
                <div class="custom-options" role="listbox" id="businessOptions"></div>
            </div>
            <select id="businessSelect" onchange="loadBusinessData()" style="display:none;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å</option>
            </select>
        </div>
    </div>
</div>

<div class="analytics-content">
    <div class="analytics-section">
        <h2>–î–µ—Ç–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</h2>
        <div id="financialAnalysis">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞...</div>
        </div>
    </div>
    
    <div class="analytics-section">
        <h2>–¢—Ä–µ–Ω–¥—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã</h2>
        <div id="trendsAnalysis">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤...</div>
        </div>
    </div>

    <div class="analytics-section">
        <h2>–°–æ–≤–µ—Ç—ã –¥–ª—è –±–∏–∑–Ω–µ—Å–∞</h2>
        <div id="adviceCard">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–≤–µ—Ç–æ–≤...</div>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
    });

    let currentBusinessId = null;

    async function loadUsers() {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            
            if (data.success) {
                const userSelect = document.getElementById('userSelect');
                const userTrigger = document.getElementById('userSelectTrigger');
                const userOptions = document.getElementById('userOptions');
                userSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</option>';
                userOptions.innerHTML = '';
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    userSelect.appendChild(option);
                    const optDiv = document.createElement('div');
                    optDiv.className = 'custom-option';
                    optDiv.setAttribute('role','option');
                    optDiv.dataset.value = user.id;
                    optDiv.innerHTML = `<span class="option-text">${user.name}</span><span class="option-check">‚úî</span>`;
                    optDiv.addEventListener('click', () => {
                        userSelect.value = user.id;
                        userTrigger.textContent = user.name;
                        closeCustomSelect('userSelectCustom');
                        loadUserData();
                    });
                    userOptions.appendChild(optDiv);
                });
                if (data.users.length > 0) {
                    userSelect.value = data.users[0].id;
                    userTrigger.textContent = data.users[0].name;
                    loadUserData();
                } else {
                    userTrigger.textContent = '–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π';
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π:', error);
        }
    }

    async function loadUserData() {
        const userId = document.getElementById('userSelect').value;
        if (!userId) return;
        // –ó–∞–≥—Ä—É–∑–∏–º –±–∏–∑–Ω–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã–±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π
        const bizResp = await fetch(`/api/businesses/${userId}`);
        const bizData = await bizResp.json();
        const businessSelect = document.getElementById('businessSelect');
        const bizTrigger = document.getElementById('businessSelectTrigger');
        const bizOptions = document.getElementById('businessOptions');
        businessSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å</option>';
        bizOptions.innerHTML = '';
        if (bizData.success && bizData.businesses.length) {
            bizData.businesses.forEach(b => {
                const option = document.createElement('option');
                option.value = b.business_id;
                option.textContent = b.business_name;
                businessSelect.appendChild(option);
                const optDiv = document.createElement('div');
                optDiv.className = 'custom-option';
                optDiv.setAttribute('role','option');
                optDiv.dataset.value = b.business_id;
                optDiv.innerHTML = `<span class="option-text">${b.business_name}</span><span class="option-check">‚úî</span>`;
                optDiv.addEventListener('click', () => {
                    businessSelect.value = b.business_id;
                    bizTrigger.textContent = b.business_name;
                    closeCustomSelect('businessSelectCustom');
                    loadBusinessData();
                });
                bizOptions.appendChild(optDiv);
            });
            businessSelect.value = bizData.businesses[0].business_id;
            bizTrigger.textContent = bizData.businesses[0].business_name;
            currentBusinessId = bizData.businesses[0].business_id;
            await loadBusinessData();
        } else {
            currentBusinessId = null;
            bizTrigger.textContent = '–ù–µ—Ç –±–∏–∑–Ω–µ—Å–æ–≤';
        }
    }

    async function loadBusinessData() {
        const businessId = document.getElementById('businessSelect').value;
        if (!businessId) return;
        currentBusinessId = businessId;
        await loadFinancialAnalysis(currentBusinessId);
        await loadTrendsAnalysis(currentBusinessId);
        await loadChartsForAnalytics(currentBusinessId);
        await loadAdvice(currentBusinessId);
    }

    async function loadFinancialAnalysis(businessId) {
        try {
            const aiResponse = await fetch(`/api/business-ai-analysis/${businessId}`);
            const aiData = await aiResponse.json();
            
            if (aiData.success) {
                renderFinancialAnalysis(aiData.analysis);
            } else {
                const container = document.getElementById('financialAnalysis');
                container.innerHTML = `<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: ${aiData.error || '—Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ'}</p>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:', error);
            const container = document.getElementById('financialAnalysis');
            container.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.</p>';
        }
    }

    async function loadTrendsAnalysis(businessId) {
        try {
            const financeResponse = await fetch(`/api/business-history/${businessId}`);
            const financeData = await financeResponse.json();
            
            if (financeData.success) {
                renderTrendsAnalysis(financeData.data);
            } else {
                const container = document.getElementById('trendsAnalysis');
                container.innerHTML = `<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤: ${financeData.error || '—Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ'}</p>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤:', error);
            const container = document.getElementById('trendsAnalysis');
            container.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.</p>';
        }
    }

    async function loadChartsForAnalytics(businessId) {
        try {
            const response = await fetch(`/api/business-history/${businessId}`);
            const data = await response.json();
            if (data.success) {
                window.currentChartData = data.data;
                if (!window.selectedMetrics || window.selectedMetrics.size === 0) {
                    window.selectedMetrics = new Set(['revenue','expenses','profit']);
                }
                renderFinanceChart(data.data);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
        }
    }

    async function loadAdvice(businessId) {
        try {
            const resp = await fetch(`/api/business-advice/${businessId}`);
            const data = await resp.json();
            const card = document.getElementById('adviceCard');
            if (data.success && data.advice && data.advice.length) {
                card.innerHTML = `
                    <div class="analysis-card">
                        <h4>üí° –°–æ–≤–µ—Ç—ã –ò–ò</h4>
                        <ul>${data.advice.map(a => `<li>${a}</li>`).join('')}</ul>
                    </div>
                `;
            } else {
                card.innerHTML = '<p>–°–æ–≤–µ—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>';
            }
        } catch (e) {
            const card = document.getElementById('adviceCard');
            card.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–≤–µ—Ç–æ–≤</p>';
        }
    }

    function renderFinancialAnalysis(analysis) {
        const container = document.getElementById('financialAnalysis');
        
        container.innerHTML = `
            <div class="analysis-card">
                <h4>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å–∞</h4>
                <div class="profitability-gauge">
                <div class="gauge-value">${Math.min(100, Math.max(0, analysis.metrics.profitability))}%</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" style="width: ${Math.min(100, Math.max(0, analysis.metrics.profitability))}%"></div>
                    </div>
                </div>
                <p>${analysis.summary}</p>
            </div>
            
            <div class="analysis-card">
                <h4>–û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h4>
                <div class="efficiency-score">${analysis.metrics.efficiency_score}/100</div>
                <p>–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤</p>
            </div>
            ${analysis.trends?.length || analysis.recommendations?.length || analysis.commentary ? `
            <div class="analysis-card">
                ${analysis.trends?.length ? `
                <h4>üîç –¢—Ä–µ–Ω–¥—ã –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h4>
                <ul>${analysis.trends.map(trend => `<li>${trend}</li>`).join('')}</ul>
                ` : ''}
                ${analysis.recommendations?.length ? `
                <h4>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h4>
                <ul>${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}</ul>
                ` : ''}
                ${analysis.commentary ? `
                <h4>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>
                <p>${analysis.commentary}</p>
                ` : ''}
            </div>
            ` : ''}
        `;
    }

    function renderTrendsAnalysis(data) {
        const container = document.getElementById('trendsAnalysis');
        
        if (data.series && data.series.revenue && data.series.revenue.length >= 2) {
            const revenueGrowth = ((data.series.revenue[0] - data.series.revenue[1]) / data.series.revenue[1] * 100).toFixed(1);
            const profitGrowth = ((data.series.profit[0] - data.series.profit[1]) / data.series.profit[1] * 100).toFixed(1);
            
            container.innerHTML = `
                <div class="trends-grid">
                    <div class="trend-card ${revenueGrowth >= 0 ? 'positive' : 'negative'}">
                        <h4>–†–æ—Å—Ç –≤—ã—Ä—É—á–∫–∏</h4>
                        <div class="trend-value">${revenueGrowth}%</div>
                    </div>
                    <div class="trend-card ${profitGrowth >= 0 ? 'positive' : 'negative'}">
                        <h4>–†–æ—Å—Ç –ø—Ä–∏–±—ã–ª–∏</h4>
                        <div class="trend-value">${profitGrowth}%</div>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = '<p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤</p>';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    function exportChart(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            alert('–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const link = document.createElement('a');
        link.download = `chart-${canvasId}-${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    // –õ–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–µ–ª–µ–∫—Ç–æ–≤
    document.addEventListener('click', function(e) {
        const userCustom = document.getElementById('userSelectCustom');
        const bizCustom = document.getElementById('businessSelectCustom');
        [userCustom, bizCustom].forEach(cs => {
            if (!cs) return;
            const trigger = cs.querySelector('.custom-select-trigger');
            if (trigger && trigger.contains(e.target)) {
                cs.classList.toggle('is-open');
            } else if (!cs.contains(e.target)) {
                cs.classList.remove('is-open');
            }
        });
    });

    function closeCustomSelect(id) {
        const cs = document.getElementById(id);
        if (cs) cs.classList.remove('is-open');
    }
</script>
{% endblock %}