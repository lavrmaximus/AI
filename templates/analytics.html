{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - BusinessAI{% endblock %}

{% block content %}
<div class="analytics-header">
    <h1>–ì–ª—É–±–æ–∫–∞—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
    <div class="enhanced-select" style="margin-top:10px;">
        <div class="dropdown-container" id="userSelectCustom">
            <button type="button" class="dropdown-button" id="userSelectTrigger">
                –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            </button>
            <div class="dropdown-menu" id="userOptions"></div>
        </div>
        <select id="userSelect" onchange="loadUserData()" style="display:none;">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
        </select>
    </div>
    
    <div class="enhanced-select" style="margin-top:10px;">
        <div class="dropdown-container" id="businessSelectCustom">
            <button type="button" class="dropdown-button" id="businessSelectTrigger">
                –í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å
            </button>
            <div class="dropdown-menu" id="businessOptions"></div>
        </div>
        <select id="businessSelect" onchange="loadBusinessData()" style="display:none;">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å</option>
        </select>
    </div>
</div>

<div class="analytics-content">
    <div class="analytics-section">
        <h2>–î–µ—Ç–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</h2>
        <div id="financialAnalysis">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞...</div>
        </div>
    </div>
    
    <div class="analytics-section">
        <h2>–¢—Ä–µ–Ω–¥—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã</h2>
        <div id="trendsAnalysis">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤...</div>
        </div>
    </div>

    <div class="analytics-section">
        <h2>–°–æ–≤–µ—Ç—ã –¥–ª—è –±–∏–∑–Ω–µ—Å–∞</h2>
        <div id="adviceCard">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–≤–µ—Ç–æ–≤...</div>
        </div>
    </div>

</div>

<script>
    let currentBusinessId = null;
    let currentUserId = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        const userIdFromUrl = '{{ user_id }}';
        loadUsers(userIdFromUrl);
    });

    async function loadCurrentUser(userId) {
        try {
            const response = await fetch(`/api/current-user/${userId}`);
            const data = await response.json();
            
            if (data.success) {
                const user = data.user;
                const displayName = user.first_name && user.last_name ? 
                    `${user.first_name} ${user.last_name}` : 
                    (user.first_name || user.username || `User ${user.user_id}`);
                
                document.getElementById('current-user-name').textContent = displayName;
                document.getElementById('user-info').style.display = 'block';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–∑–Ω–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await loadUserBusinesses(userId);
            } else {
                console.error('User not found:', data.error);
            }
        } catch (error) {
            console.error('Error loading current user:', error);
        }
    }

    async function loadUserBusinesses(userId) {
        try {
            const response = await fetch(`/api/businesses/${userId}`);
            const data = await response.json();
            
            if (data.success && data.businesses.length > 0) {
                const businessSelect = document.getElementById('businessSelect');
                const bizTrigger = document.getElementById('businessSelectTrigger');
                const bizOptions = document.getElementById('businessOptions');
                
                businessSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å</option>';
                while (bizOptions.firstChild) {
                    bizOptions.removeChild(bizOptions.firstChild);
                }
                
                data.businesses.forEach(b => {
                    const option = document.createElement('option');
                    option.value = b.business_id;
                    const bizName = (b && b.business_name) ? b.business_name : `–ë–∏–∑–Ω–µ—Å ${b && b.business_id ? b.business_id : ''}`;
                    option.textContent = bizName;
                    businessSelect.appendChild(option);
                    
                    const optDiv = document.createElement('div');
                    optDiv.className = 'dropdown-option';
                    optDiv.dataset.value = b.business_id;
                    optDiv.textContent = bizName;
                    optDiv.addEventListener('click', () => {
                        businessSelect.value = b.business_id;
                        bizTrigger.textContent = bizName;
                        closeCustomSelect('businessSelectCustom');
                        loadBusinessData();
                    });
                    bizOptions.appendChild(optDiv);
                });
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –±–∏–∑–Ω–µ—Å
                businessSelect.value = data.businesses[0].business_id;
                bizTrigger.textContent = (data.businesses[0] && data.businesses[0].business_name) ? 
                    data.businesses[0].business_name : `–ë–∏–∑–Ω–µ—Å ${data.businesses[0].business_id}`;
                currentBusinessId = data.businesses[0].business_id;
                await loadBusinessData();
            } else {
                bizTrigger.textContent = '–ù–µ—Ç –±–∏–∑–Ω–µ—Å–æ–≤';
            }
        } catch (error) {
            console.error('Error loading user businesses:', error);
        }
    }

    async function loadUsers(userIdToSelect) {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            
            if (data.success) {
                const userSelect = document.getElementById('userSelect');
                const userTrigger = document.getElementById('userSelectTrigger');
                const userOptions = document.getElementById('userOptions');
                
                if (!userSelect || !userTrigger || !userOptions) {
                    console.error('User selector elements not found');
                    return;
                }
                
                userSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</option>';
                userOptions.innerHTML = '';
                
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.user_id;
                    const displayName = user.first_name && user.last_name ? 
                        `${user.first_name} ${user.last_name}` : 
                        (user.first_name || user.username || `User ${user.user_id}`);
                    option.textContent = displayName;
                    userSelect.appendChild(option);
                    
                    const optDiv = document.createElement('div');
                    optDiv.className = 'dropdown-option';
                    optDiv.dataset.value = user.user_id;
                    optDiv.textContent = displayName;
                    optDiv.addEventListener('click', () => {
                        userSelect.value = user.user_id;
                        userTrigger.textContent = displayName;
                        closeCustomSelect('userSelectCustom');
                        loadUserData();
                    });
                    userOptions.appendChild(optDiv);
                });
                
                if (userIdToSelect) {
                    const userExists = data.users.some(user => user.user_id === userIdToSelect);
                    if (userExists) {
                        userSelect.value = userIdToSelect;
                        const selectedUser = data.users.find(user => user.user_id === userIdToSelect);
                        const displayName = selectedUser.first_name && selectedUser.last_name ? 
                            `${selectedUser.first_name} ${selectedUser.last_name}` : 
                            (selectedUser.first_name || selectedUser.username || `User ${selectedUser.user_id}`);
                        userTrigger.textContent = displayName;
                        loadUserData();
                    }
                } else if (data.users.length > 0) {
                    userSelect.value = data.users[0].user_id;
                    const firstUser = data.users[0];
                    const displayName = firstUser.first_name && firstUser.last_name ? 
                        `${firstUser.first_name} ${firstUser.last_name}` : 
                        (firstUser.first_name || firstUser.username || `User ${firstUser.user_id}`);
                    userTrigger.textContent = displayName;
                    loadUserData();
                } else {
                    userTrigger.textContent = '–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π';
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π:', error);
        }
    }

    async function loadUserData() {
        const userId = document.getElementById('userSelect').value;
        if (!userId) return;
        currentUserId = userId;
        await loadUserBusinesses(userId);
    }

    async function loadBusinessData() {
        const businessId = document.getElementById('businessSelect').value;
        if (!businessId) return;
        currentBusinessId = businessId;
        await loadFinancialAnalysis(currentBusinessId);
        await loadTrendsAnalysis(currentBusinessId);
        await loadChartsForAnalytics(currentBusinessId);
        await loadAdvice(currentBusinessId);
    }

    async function loadFinancialAnalysis(businessId) {
        try {
            const aiResponse = await fetch(`/api/business-ai-analysis/${businessId}`);
            const aiData = await aiResponse.json();
            
            if (aiData.success) {
                renderFinancialAnalysis(aiData.analysis);
            } else {
                const container = document.getElementById('financialAnalysis');
                container.innerHTML = `<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: ${aiData.error || '—Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ'}</p>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:', error);
            const container = document.getElementById('financialAnalysis');
            container.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.</p>';
        }
    }

    async function loadTrendsAnalysis(businessId) {
        try {
            const financeResponse = await fetch(`/api/business-history/${businessId}`);
            const financeData = await financeResponse.json();
            
            if (financeData.success) {
                renderTrendsAnalysis(financeData.data);
            } else {
                const container = document.getElementById('trendsAnalysis');
                container.innerHTML = `<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤: ${financeData.error || '—Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ'}</p>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤:', error);
            const container = document.getElementById('trendsAnalysis');
            container.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.</p>';
        }
    }

    async function loadChartsForAnalytics(businessId) {
        try {
            const response = await fetch(`/api/business-history/${businessId}`);
            const data = await response.json();
            if (data.success) {
                window.currentChartData = data.data;
                if (!window.selectedMetrics || window.selectedMetrics.size === 0) {
                    window.selectedMetrics = new Set(['revenue','expenses','profit']);
                }
                renderFinanceChart(data.data);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
        }
    }

    async function loadAdvice(businessId) {
        try {
            const resp = await fetch(`/api/business-advice/${businessId}`);
            const data = await resp.json();
            const card = document.getElementById('adviceCard');
            const section = card.closest('.analytics-section');
            
            if (data.success && data.advice && data.advice.length) {
                card.innerHTML = `
                    <div class="analysis-card">
                        <h4>üí° –°–æ–≤–µ—Ç—ã –ò–ò</h4>
                        <ul>${data.advice.map(a => `<li>${a}</li>`).join('')}</ul>
                    </div>
                `;
                section.style.display = 'block';
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—é —Å–µ–∫—Ü–∏—é —Å–æ–≤–µ—Ç–æ–≤, –µ—Å–ª–∏ —Å–æ–≤–µ—Ç–æ–≤ –æ—Ç –ò–ò –Ω–µ—Ç
                section.style.display = 'none';
            }
        } catch (e) {
            const card = document.getElementById('adviceCard');
            const section = card.closest('.analytics-section');
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
            section.style.display = 'none';
        }
    }

    async function loadChartsForAnalytics(businessId) {
        try {
            const response = await fetch(`/api/business-history/${businessId}`);
            const data = await response.json();
            if (data.success) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏–∑ dashboard
                window.currentChartData = data.data;
                if (!window.selectedMetrics || window.selectedMetrics.size === 0) {
                    window.selectedMetrics = new Set(['revenue','expenses','profit']);
                }
                renderFinanceChart(data.data);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
        }
    }

    function renderFinancialAnalysis(analysis) {
        const container = document.getElementById('financialAnalysis');
        
        container.innerHTML = `
            <div class="analysis-card">
                <h4>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å–∞</h4>
                <div class="profitability-gauge">
                <div class="gauge-value">${Math.min(100, Math.max(0, analysis.metrics.profitability))}%</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" style="width: ${Math.min(100, Math.max(0, analysis.metrics.profitability))}%"></div>
                    </div>
                </div>
                <p>${analysis.summary}</p>
            </div>
            
            <div class="analysis-card">
                <h4>–û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h4>
                <div class="efficiency-score">${analysis.metrics.efficiency_score}/100</div>
                <p>–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤</p>
            </div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É "–¢—Ä–µ–Ω–¥—ã –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å ai_commentary
        if (analysis.commentary && analysis.commentary.trim()) {
            container.innerHTML += `
                <div class="analysis-card">
                    <h4>üîç –¢—Ä–µ–Ω–¥—ã –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h4>
                    <p>${analysis.commentary}</p>
                </div>
            `;
        }
    }

    function renderTrendsAnalysis(data) {
        const container = document.getElementById('trendsAnalysis');
        
        if (data.series && data.series.revenue && data.series.revenue.length >= 2) {
            const revenueGrowth = ((data.series.revenue[0] - data.series.revenue[1]) / data.series.revenue[1] * 100).toFixed(1);
            const profitGrowth = ((data.series.profit[0] - data.series.profit[1]) / data.series.profit[1] * 100).toFixed(1);
            
            container.innerHTML = `
                <div class="trends-grid">
                    <div class="trend-card ${revenueGrowth >= 0 ? 'positive' : 'negative'}">
                        <h4>–†–æ—Å—Ç –≤—ã—Ä—É—á–∫–∏</h4>
                        <div class="trend-value">${revenueGrowth}%</div>
                    </div>
                    <div class="trend-card ${profitGrowth >= 0 ? 'positive' : 'negative'}">
                        <h4>–†–æ—Å—Ç –ø—Ä–∏–±—ã–ª–∏</h4>
                        <div class="trend-value">${profitGrowth}%</div>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = '<p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤</p>';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    function exportChart(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            alert('–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const link = document.createElement('a');
        link.download = `chart-${canvasId}-${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    // –õ–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö –º–µ–Ω—é
    document.addEventListener('click', function(e) {
        const userCustom = document.getElementById('userSelectCustom');
        const bizCustom = document.getElementById('businessSelectCustom');
        
        [userCustom, bizCustom].forEach((container, index) => {
            if (!container) return;
            
            const button = container.querySelector('.dropdown-button');
            const menu = container.querySelector('.dropdown-menu');
            
            if (!button || !menu) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –∏–º–µ–Ω–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ, –Ω–æ –Ω–µ –ø–æ –º–µ–Ω—é –≤–Ω—É—Ç—Ä–∏
            if (button.contains(e.target) && !menu.contains(e.target)) {
                container.classList.toggle('open');
            } else if (!container.contains(e.target)) {
                container.classList.remove('open');
            }
        });
    });

    function closeCustomSelect(id) {
        const container = document.getElementById(id);
        if (container) container.classList.remove('open');
    }
</script>
{% endblock %}