{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - BusinessAI{% endblock %}

{% block content %}
<div class="analytics-header">
    <h1>–ì–ª—É–±–æ–∫–∞—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
    <div class="user-selector">
        <label for="userSelect">üîç –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
        <div class="enhanced-select">
            <select id="userSelect" onchange="loadAnalyticsData()">
                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
            </select>
        </div>
    </div>
</div>

<div class="analytics-content">
    <div class="analytics-section">
        <h2>–î–µ—Ç–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</h2>
        <div id="financialAnalysis">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞...</div>
        </div>
    </div>
    
    <div class="analytics-section">
        <h2>–¢—Ä–µ–Ω–¥—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã</h2>
        <div id="trendsAnalysis">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤...</div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
    });

    async function loadUsers() {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            
            if (data.success) {
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>';
                
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    userSelect.appendChild(option);
                });
                
                if (data.users.length > 0) {
                    userSelect.value = data.users[0].id;
                    loadAnalyticsData();
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        }
    }

    async function loadAnalyticsData() {
        const userId = document.getElementById('userSelect').value;
        if (!userId) return;

        await loadFinancialAnalysis(userId);
        await loadTrendsAnalysis(userId);
    }

    async function loadFinancialAnalysis(userId) {
        try {
            const response = await fetch(`/api/user-ai-analysis/${userId}`);
            const data = await response.json();
            
            if (data.success) {
                renderFinancialAnalysis(data.analysis);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:', error);
        }
    }

    async function loadTrendsAnalysis(userId) {
        try {
            const financeResponse = await fetch(`/api/user-finance-data/${userId}`);
            const financeData = await financeResponse.json();
            
            if (financeData.success) {
                renderTrendsAnalysis(financeData.data);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤:', error);
        }
    }

    function renderFinancialAnalysis(analysis) {
        const container = document.getElementById('financialAnalysis');
        
        container.innerHTML = `
            <div class="analysis-card">
                <h4>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å–∞</h4>
                <div class="profitability-gauge">
                    <div class="gauge-value">${analysis.metrics.profitability}%</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" style="width: ${Math.min(analysis.metrics.profitability, 100)}%"></div>
                    </div>
                </div>
                <p>${analysis.summary}</p>
            </div>
            
            <div class="analysis-card">
                <h4>–û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h4>
                <div class="efficiency-score">${analysis.metrics.efficiency_score}/100</div>
                <p>–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤</p>
            </div>
        `;
    }

    function renderTrendsAnalysis(data) {
        const container = document.getElementById('trendsAnalysis');
        
        if (data.revenue.length >= 2) {
            const revenueGrowth = ((data.revenue[0] - data.revenue[1]) / data.revenue[1] * 100).toFixed(1);
            const profitGrowth = ((data.profit[0] - data.profit[1]) / data.profit[1] * 100).toFixed(1);
            
            container.innerHTML = `
                <div class="trends-grid">
                    <div class="trend-card ${revenueGrowth >= 0 ? 'positive' : 'negative'}">
                        <h4>–†–æ—Å—Ç –≤—ã—Ä—É—á–∫–∏</h4>
                        <div class="trend-value">${revenueGrowth}%</div>
                    </div>
                    <div class="trend-card ${profitGrowth >= 0 ? 'positive' : 'negative'}">
                        <h4>–†–æ—Å—Ç –ø—Ä–∏–±—ã–ª–∏</h4>
                        <div class="trend-value">${profitGrowth}%</div>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = '<p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤</p>';
        }
    }
</script>
{% endblock %}