{% extends "base.html" %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - BusinessAI{% endblock %}

{% block content %}
<div class="user-selector">
    <label for="userSelect">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å:</label>
    <div class="enhanced-select">
        <select id="userSelect" onchange="loadUserData()">
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
        </select>
    </div>
</div>

<!-- KPI Cards -->
<div class="kpi-section">
    <h2>–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h2>
    <div class="kpi-grid" id="kpiGrid">
        <div class="kpi-card">
            <h3>–í—ã—Ä—É—á–∫–∞</h3>
            <div class="value" id="revenue-value">0 ‚ÇΩ</div>
            <div class="change" id="revenue-change">+0%</div>
        </div>
        <div class="kpi-card">
            <h3>–†–∞—Å—Ö–æ–¥—ã</h3>
            <div class="value" id="expenses-value">0 ‚ÇΩ</div>
            <div class="change" id="expenses-change">+0%</div>
        </div>
        <div class="kpi-card">
            <h3>–ü—Ä–∏–±—ã–ª—å</h3>
            <div class="value" id="profit-value">0 ‚ÇΩ</div>
            <div class="change" id="profit-change">+0%</div>
        </div>
        <div class="kpi-card">
            <h3>–ö–ª–∏–µ–Ω—Ç—ã</h3>
            <div class="value" id="clients-value">0</div>
            <div class="change" id="clients-change">+0%</div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-section">
    <div class="chart-container">
        <h3>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –¥–∏–Ω–∞–º–∏–∫–∞</h3>
        <div class="chart-wrapper">
            <canvas id="financeChart"></canvas>
        </div>
    </div>
    
    <div class="metrics-container">
        <h3>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h3>
        <div class="metrics-grid">
            <div class="metric-item">
                <span class="metric-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</span>
                <span class="metric-value" id="avg-check-value">0 ‚ÇΩ</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">–†–µ–π—Ç–∏–Ω–≥ –±–∏–∑–Ω–µ—Å–∞</span>
                <span class="metric-value" id="rating-value">0/10</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</span>
                <span class="metric-value" id="profitability-value">0%</span>
            </div>
        </div>
    </div>
</div>

<!-- AI Analysis Section -->
<div class="analysis-section">
    <h2>–ê–Ω–∞–ª–∏–∑ –æ—Ç –ò–ò</h2>
    <div id="aiAnalysis">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞...</div>
    </div>
</div>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    let financeChart = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
    });

    async function loadUsers() {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            
            if (data.success) {
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>';
                
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    userSelect.appendChild(option);
                });
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                if (data.users.length > 0) {
                    userSelect.value = data.users[0].id;
                    loadUserData();
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        }
    }

    async function loadUserData() {
        const userId = document.getElementById('userSelect').value;
        if (!userId) return;

        await loadKPIMetrics(userId);
        await loadFinanceData(userId);
        await loadAIAnalysis(userId);
    }

    async function loadKPIMetrics(userId) {
        try {
            const response = await fetch(`/api/user-kpi-metrics/${userId}`);
            const data = await response.json();
            
            if (data.success) {
                updateKPICards(data.kpi);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ KPI:', error);
        }
    }

    async function loadFinanceData(userId) {
        try {
            const response = await fetch(`/api/user-finance-data/${userId}`);
            const data = await response.json();
            
            if (data.success) {
                renderFinanceChart(data.data);
                updateAdditionalMetrics(data.latest, data.data);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    }

    async function loadAIAnalysis(userId) {
        try {
            const response = await fetch(`/api/user-ai-analysis/${userId}`);
            const data = await response.json();
            
            if (data.success) {
                renderAIAnalysis(data.analysis);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ AI –∞–Ω–∞–ª–∏–∑–∞:', error);
        }
    }

    function updateKPICards(kpi) {
        updateKPICard('revenue', kpi.revenue, '‚ÇΩ');
        updateKPICard('expenses', kpi.expenses, '‚ÇΩ');
        updateKPICard('profit', kpi.profit, '‚ÇΩ');
        updateKPICard('clients', kpi.clients, '');
    }

    function updateKPICard(type, data, suffix) {
        const valueElement = document.getElementById(`${type}-value`);
        const changeElement = document.getElementById(`${type}-change`);
        
        valueElement.textContent = formatNumber(data.current) + (suffix ? ' ' + suffix : '');
        
        const change = data.change || 0;
        changeElement.textContent = (change > 0 ? '+' : '') + change + '%';
        changeElement.className = `change ${change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral'}`;
    }

    function updateAdditionalMetrics(latest, financeData) {
        if (latest) {
            document.getElementById('avg-check-value').textContent = 
                formatNumber(latest.average_check) + ' ‚ÇΩ';
            document.getElementById('rating-value').textContent = 
                (latest.rating || 0) + '/10';
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å
            if (financeData && financeData.revenue.length > 0) {
                const currentRevenue = financeData.revenue[0];
                const currentProfit = financeData.profit[0];
                const profitability = currentRevenue > 0 ? (currentProfit / currentRevenue * 100) : 0;
                document.getElementById('profitability-value').textContent = 
                    profitability.toFixed(1) + '%';
            }
        }
    }

function renderFinanceChart(data) {
    const canvas = document.getElementById('financeChart');
    const ctx = canvas.getContext('2d');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ
    if (!data || !data.dates || data.dates.length === 0) {
        console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞');
        return;
    }
    
    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (financeChart) {
        console.log('–£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫');
        financeChart.destroy();
        financeChart = null;
    }
    
    // –ñ–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ tick –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –æ—á–∏—Å—Ç–∫–∏
    setTimeout(() => {
        try {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
            financeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [
                        {
                            label: '–í—ã—Ä—É—á–∫–∞',
                            data: data.revenue,
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '–†–∞—Å—Ö–æ–¥—ã',
                            data: data.expenses,
                            borderColor: '#f56565',
                            backgroundColor: 'rgba(245, 101, 101, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '–ü—Ä–∏–±—ã–ª—å',
                            data: data.profit,
                            borderColor: '#4299e1',
                            backgroundColor: 'rgba(66, 153, 225, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true, // –ò–∑–º–µ–Ω–∏–ª–∏ –Ω–∞ true
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                                }
                            }
                        }
                    }
                }
            });
            console.log('–ì—Ä–∞—Ñ–∏–∫ —Å–æ–∑–¥–∞–Ω');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞:', error);
        }
    }, 10);
}

    function renderAIAnalysis(analysis) {
        const container = document.getElementById('aiAnalysis');
        
        container.innerHTML = `
            <div class="ai-summary">
                <h4>üìà –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑</h4>
                <p>${analysis.summary}</p>
            </div>
            
            <div class="ai-metrics">
                <h4>üìä –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
                <div class="metrics-grid">
                    <div class="metric-badge">
                        <span class="metric-label">–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</span>
                        <span class="metric-value">${analysis.metrics.profitability}%</span>
                    </div>
                    <div class="metric-badge">
                        <span class="metric-label">–û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</span>
                        <span class="metric-value">${analysis.metrics.efficiency_score}/100</span>
                    </div>
                </div>
            </div>
            
            <div class="ai-trends">
                <h4>üîç –¢—Ä–µ–Ω–¥—ã –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h4>
                <ul>
                    ${analysis.trends.map(trend => `<li>${trend}</li>`).join('')}
                </ul>
            </div>
            
            <div class="ai-recommendations">
                <h4>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h4>
                <ul>
                    ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
            
            ${analysis.commentary ? `
            <div class="ai-commentary">
                <h4>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>
                <p>${analysis.commentary}</p>
            </div>
            ` : ''}
        `;
    }

    function formatNumber(num) {
        return new Intl.NumberFormat('ru-RU').format(Math.round(num));
    }
</script>
{% endblock %}