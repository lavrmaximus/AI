{% extends "base.html" %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ª—É—á{% endblock %}

{% block content %}
<div class="user-selector">
    <label for="userSelect">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å:</label>
    <div class="enhanced-select">
        <div class="dropdown-container" id="userSelectCustom">
            <button type="button" class="dropdown-button" id="userSelectTrigger">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </button>
            <div class="dropdown-menu" id="userOptions"></div>
        </div>
        <select id="userSelect" onchange="loadUserData()" style="display:none;">
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
        </select>
    </div>
    <div class="enhanced-select" style="margin-top:10px;">
        <div class="dropdown-container" id="businessSelectCustom">
            <button type="button" class="dropdown-button" id="businessSelectTrigger">
                –í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å
            </button>
            <div class="dropdown-menu" id="businessOptions"></div>
        </div>
        <select id="businessSelect" onchange="loadBusinessData()" style="display:none;">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å</option>
        </select>
    </div>
</div>

<!-- KPI Cards -->
<div class="kpi-section">
    <h2>–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h2>
    <div class="kpi-grid" id="kpiGrid">
        <div class="kpi-card">
            <h3>–í—ã—Ä—É—á–∫–∞</h3>
            <div class="value" id="revenue-value">0 ‚ÇΩ</div>
            <div class="change" id="revenue-change">+0%</div>
        </div>
        <div class="kpi-card">
            <h3>–†–∞—Å—Ö–æ–¥—ã</h3>
            <div class="value" id="expenses-value">0 ‚ÇΩ</div>
            <div class="change" id="expenses-change">+0%</div>
        </div>
        <div class="kpi-card">
            <h3>–ü—Ä–∏–±—ã–ª—å</h3>
            <div class="value" id="profit-value">0 ‚ÇΩ</div>
            <div class="change" id="profit-change">+0%</div>
        </div>
        <div class="kpi-card">
            <h3>–ö–ª–∏–µ–Ω—Ç—ã</h3>
            <div class="value" id="clients-value">0</div>
            <div class="change" id="clients-change">+0%</div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-section">
    <div class="chart-container">
        <div class="chart-header">
            <h3>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ (‚ÇΩ)</h3>
            <div class="chart-actions">
                <div class="time-range">
                    <button class="range-btn" data-range="day" onclick="setTimeRange('day')">–î–µ–Ω—å</button>
                    <button class="range-btn" data-range="week" onclick="setTimeRange('week')">–ù–µ–¥–µ–ª—è</button>
                    <button class="range-btn" data-range="month" onclick="setTimeRange('month')">–ú–µ—Å—è—Ü</button>
                    <button class="range-btn" data-range="quarter" onclick="setTimeRange('quarter')">–ö–≤–∞—Ä—Ç–∞–ª</button>
                    <button class="range-btn active" data-range="all" onclick="setTimeRange('all')">–í—Å–µ</button>
                </div>
                <button class="export-btn" onclick="exportChart('financeChartCurrency')">üìä –≠–∫—Å–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∏–∫–∞ PNG</button>
            </div>
        </div>
        
        <div class="scrollable-chart-container chart-no-scroll">
            <div class="chart-wrapper">
                <canvas id="financeChartCurrency"></canvas>
                <div id="cursorLineCurrency" class="cursor-line" style="display:none;"></div>
            </div>
            <div id="chartReadoutCurrency" class="chart-readout" aria-hidden="true"></div>
        </div>
    </div>

    <div class="chart-container" style="margin-top: 16px;">
        <div class="chart-header">
            <h3>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π (—à—Ç—É–∫–∏)</h3>
            <div class="chart-actions">
                <button class="export-btn" onclick="exportChart('financeChartCounts')">üìä –≠–∫—Å–ø–æ—Ä—Ç PNG</button>
            </div>
        </div>
        <div class="scrollable-chart-container chart-no-scroll">
            <div class="chart-wrapper">
                <canvas id="financeChartCounts"></canvas>
                <div id="cursorLineCounts" class="cursor-line" style="display:none;"></div>
            </div>
            <div id="chartReadoutCounts" class="chart-readout" aria-hidden="true"></div>
        </div>
    </div>

    <div class="chart-container" style="margin-top: 16px;">
        <div class="chart-header">
            <h3>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π (%)</h3>
            <div class="chart-actions">
                <button class="export-btn" onclick="exportChart('financeChartPercent')">üìä –≠–∫—Å–ø–æ—Ä—Ç PNG</button>
            </div>
        </div>
        <div class="scrollable-chart-container chart-no-scroll">
            <div class="chart-wrapper">
                <canvas id="financeChartPercent"></canvas>
                <div id="cursorLinePercent" class="cursor-line" style="display:none;"></div>
            </div>
            <div id="chartReadoutPercent" class="chart-readout" aria-hidden="true"></div>
        </div>
    </div>
    
    <div class="metrics-container">
        <div style="display:flex; align-items:center; gap:12px; justify-content:space-between;">
            <h3>–í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ (–≤–∫–ª/–≤—ã–∫–ª –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞)</h3>
            <div>
                <button class="range-btn" onclick="selectAllMetrics(true)">–í–∫–ª—é—á–∏—Ç—å –≤—Å–µ</button>
                <button class="range-btn" onclick="selectAllMetrics(false)">–í—ã–∫–ª—é—á–∏—Ç—å –≤—Å–µ</button>
            </div>
        </div>
        <div class="kpi-grid" id="allMetricsGrid"></div>
    </div>
</div>





<script>
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    let financeChart = null; // –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    let financeChartCurrency = null;
    let financeChartCounts = null;
    let financeChartPercent = null;
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫ –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–π
    const METRICS = [
        { key: 'revenue', label: '–í—ã—Ä—É—á–∫–∞', unit: '‚ÇΩ' },
        { key: 'expenses', label: '–†–∞—Å—Ö–æ–¥—ã', unit: '‚ÇΩ' },
        { key: 'profit', label: '–ü—Ä–∏–±—ã–ª—å', unit: '‚ÇΩ' },
        { key: 'clients', label: '–ö–ª–∏–µ–Ω—Ç—ã', unit: '' },
        { key: 'average_check', label: '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫', unit: '‚ÇΩ' },
        { key: 'investments', label: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', unit: '‚ÇΩ' },
        { key: 'marketing_costs', label: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥', unit: '‚ÇΩ' },
        { key: 'employees', label: '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏', unit: '' },
        { key: 'profit_margin', label: '–ú–∞—Ä–∂–∞ –ø—Ä–∏–±—ã–ª–∏, %', unit: '%' },
        { key: 'break_even_clients', label: '–¢–æ—á–∫–∞ –±–µ–∑—É–±., –∫–ª–∏–µ–Ω—Ç—ã', unit: '' },
        { key: 'safety_margin', label: '–ó–∞–ø–∞—Å –ø—Ä–æ—á–Ω–æ—Å—Ç–∏, %', unit: '%' },
        { key: 'roi', label: 'ROI, %', unit: '%' },
        { key: 'profitability_index', label: '–ò–Ω–¥–µ–∫—Å –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏', unit: '' },
        { key: 'ltv', label: 'LTV', unit: '‚ÇΩ' },
        { key: 'cac', label: 'CAC', unit: '‚ÇΩ' },
        { key: 'ltv_cac_ratio', label: 'LTV/CAC', unit: '' },
        { key: 'customer_profit_margin', label: '–ú–∞—Ä–∂–∞ –∫–ª–∏–µ–Ω—Ç–∞, %', unit: '%' },
        { key: 'sgr', label: 'Sustainable Growth, %', unit: '%' },
        { key: 'revenue_growth_rate', label: '–†–æ—Å—Ç –≤—ã—Ä—É—á–∫–∏, %', unit: '%' },
        { key: 'asset_turnover', label: '–û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å –∞–∫—Ç–∏–≤–æ–≤', unit: '' },
        { key: 'roe', label: 'ROE, %', unit: '%' },
        { key: 'months_to_bankruptcy', label: '–ú–µ—Å. –¥–æ –±–∞–Ω–∫—Ä.', unit: '' },
        { key: 'financial_health_score', label: '–§–∏–Ω. –∑–¥–æ—Ä–æ–≤—å–µ', unit: '' },
        { key: 'growth_health_score', label: '–†–æ—Å—Ç –∑–¥–æ—Ä–æ–≤—å–µ', unit: '' },
        { key: 'efficiency_health_score', label: '–≠—Ñ—Ñ. –∑–¥–æ—Ä–æ–≤—å–µ', unit: '' },
        { key: 'overall_health_score', label: '–ò—Ç–æ–≥–æ–≤—ã–π Health', unit: '' }
    ];
    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–∏–º –±–∞–∑–æ–≤—ã–µ 3 —Å–µ—Ä–∏–∏
    let selectedMetrics = new Set(['revenue','expenses','profit']);
    let currentBusinessId = null;
    window.selectedMetrics = selectedMetrics;

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
    });

    async function loadUsers() {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            
            if (data.success) {
                const userSelect = document.getElementById('userSelect');
                const userTrigger = document.getElementById('userSelectTrigger');
                const userOptions = document.getElementById('userOptions');
                
                userSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</option>';
                // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –Ω–µ —É–¥–∞–ª—è–µ–º —Å–∞–º —ç–ª–µ–º–µ–Ω—Ç
                while (userOptions.firstChild) {
                    userOptions.removeChild(userOptions.firstChild);
                }
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.user_id;
                    const displayName = user.first_name && user.last_name ? 
                        `${user.first_name} ${user.last_name}` : 
                        (user.first_name || user.username || `User ${user.user_id}`);
                    option.textContent = displayName;
                    userSelect.appendChild(option);
                    const optDiv = document.createElement('div');
                    optDiv.className = 'dropdown-option';
                    optDiv.dataset.value = user.user_id;
                    optDiv.textContent = displayName;
                    optDiv.addEventListener('click', () => {
                        userSelect.value = user.user_id;
                        userTrigger.textContent = displayName;
                        closeCustomSelect('userSelectCustom');
                        loadUserData();
                    });
                    userOptions.appendChild(optDiv);
                });
                if (data.users.length > 0) {
                    userSelect.value = data.users[0].user_id;
                    const firstUser = data.users[0];
                    const displayName = firstUser.first_name && firstUser.last_name ? 
                        `${firstUser.first_name} ${firstUser.last_name}` : 
                        (firstUser.first_name || firstUser.username || `User ${firstUser.user_id}`);
                    userTrigger.textContent = displayName;
                    loadUserData();
                } else {
                    userTrigger.textContent = '–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π';
                }
                
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        }
    }

    async function loadUserData() {
        const userId = document.getElementById('userSelect').value;
        if (!userId) return;
        // –ó–∞–≥—Ä—É–∑–∏–º –±–∏–∑–Ω–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã–±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π
        const bizResp = await fetch(`/api/businesses/${userId}`);
        const bizData = await bizResp.json();
        const businessSelect = document.getElementById('businessSelect');
        const bizTrigger = document.getElementById('businessSelectTrigger');
        const bizOptions = document.getElementById('businessOptions');
        
        businessSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å</option>';
        // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –Ω–µ —É–¥–∞–ª—è–µ–º —Å–∞–º —ç–ª–µ–º–µ–Ω—Ç
        while (bizOptions.firstChild) {
            bizOptions.removeChild(bizOptions.firstChild);
        }
        if (bizData.success && bizData.businesses.length) {
                    bizData.businesses.forEach(b => {
                const option = document.createElement('option');
                option.value = b.business_id;
                        const bizName = (b && b.business_name) ? b.business_name : `–ë–∏–∑–Ω–µ—Å ${b && b.business_id ? b.business_id : ''}`;
                        option.textContent = bizName;
                businessSelect.appendChild(option);
                const optDiv = document.createElement('div');
                optDiv.className = 'dropdown-option';
                optDiv.dataset.value = b.business_id;
                optDiv.textContent = bizName;
                optDiv.addEventListener('click', () => {
                    businessSelect.value = b.business_id;
                    bizTrigger.textContent = bizName;
                    closeCustomSelect('businessSelectCustom');
                    loadBusinessData();
                });
                bizOptions.appendChild(optDiv);
            });
            businessSelect.value = bizData.businesses[0].business_id;
            bizTrigger.textContent = (bizData.businesses[0] && bizData.businesses[0].business_name) ? bizData.businesses[0].business_name : `–ë–∏–∑–Ω–µ—Å ${bizData.businesses[0].business_id}`;
            currentBusinessId = bizData.businesses[0].business_id;
            await loadBusinessData();
        } else {
            currentBusinessId = null;
            bizTrigger.textContent = '–ù–µ—Ç –±–∏–∑–Ω–µ—Å–æ–≤';
        }
    }

    async function loadBusinessData() {
        const businessId = document.getElementById('businessSelect').value;
        if (!businessId) return;
        currentBusinessId = businessId;
        await loadKPIMetricsForBusiness(businessId);
        await loadFinanceDataForBusiness(businessId);
    }

    async function loadKPIMetricsForBusiness(businessId) {
        try {
            const response = await fetch(`/api/business-kpi/${businessId}`);
            const data = await response.json();
            if (data.success) {
                updateKPICards(data.kpi);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ KPI:', error);
        }
    }

    async function loadFinanceDataForBusiness(businessId) {
        try {
            const response = await fetch(`/api/business-history/${businessId}`);
            const data = await response.json();
            if (data.success) {
                buildAllMetricCards(data.latest, data.data);
                // –°–æ—Ö—Ä–∞–Ω–∏–º –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è script.js
                window.currentChartData = data.data;
                // –ù–µ –ø–µ—Ä–µ-–≤–∫–ª—é—á–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —É–≤–∞–∂–∞–µ–º –ø—É—Å—Ç–æ–π –Ω–∞–±–æ—Ä
                renderFinanceChart(data.data);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–∏–∑–Ω–µ—Å–∞:', error);
        }
    }


    function updateKPICards(kpi) {
        updateKPICard('revenue', kpi.revenue, '‚ÇΩ');
        updateKPICard('expenses', kpi.expenses, '‚ÇΩ');
        updateKPICard('profit', kpi.profit, '‚ÇΩ');
        updateKPICard('clients', kpi.clients, '');
    }

    function updateKPICard(type, data, suffix) {
        const valueElement = document.getElementById(`${type}-value`);
        const changeElement = document.getElementById(`${type}-change`);
        
        valueElement.textContent = formatNumber(data.current) + (suffix ? ' ' + suffix : '');
        
        const change = data.change || 0;
        changeElement.textContent = (change > 0 ? '+' : '') + change + '%';
        
        // –î–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞—Ç–Ω–∞—è: —É–≤–µ–ª–∏—á–µ–Ω–∏–µ = –ø–ª–æ—Ö–æ (–∫—Ä–∞—Å–Ω—ã–π), —É–º–µ–Ω—å—à–µ–Ω–∏–µ = —Ö–æ—Ä–æ—à–æ (–∑–µ–ª–µ–Ω—ã–π)
        if (type === 'expenses') {
            changeElement.className = `change ${change > 0 ? 'negative' : change < 0 ? 'positive' : 'neutral'}`;
        } else {
            changeElement.className = `change ${change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral'}`;
        }
    }

    function buildAllMetricCards(latest, data) {
        const grid = document.getElementById('allMetricsGrid');
        grid.innerHTML = '';
        METRICS.forEach(m => {
            const card = document.createElement('div');
            card.className = 'kpi-card';
            const title = document.createElement('h3');
            title.textContent = m.label;
            const value = document.createElement('div');
            value.className = 'value';
            // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ (—Å–∞–º–æ–µ –Ω–æ–≤–æ–µ) –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–µ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö
            const latestVal = (data.series[m.key] && data.series[m.key].length) ? 
                data.series[m.key][data.series[m.key].length-1] : 
                (latest && (latest[m.key] != null) ? latest[m.key] : 0);
            value.textContent = formatNumber(latestVal) + (m.unit ? ' ' + m.unit : '');
            const toggle = document.createElement('button');
            toggle.className = 'range-btn';
            const enabled = window.selectedMetrics.has(m.key);
            toggle.classList.toggle('active', enabled);
            toggle.textContent = enabled ? '–ü–æ–∫–∞–∑–∞—Ç—å: –¥–∞' : '–ü–æ–∫–∞–∑–∞—Ç—å: –Ω–µ—Ç';
            toggle.onclick = () => {
                if (window.selectedMetrics.has(m.key)) {
                    window.selectedMetrics.delete(m.key);
                } else {
                    window.selectedMetrics.add(m.key);
                }
                toggle.classList.toggle('active', window.selectedMetrics.has(m.key));
                toggle.textContent = window.selectedMetrics.has(m.key) ? '–ü–æ–∫–∞–∑–∞—Ç—å: –¥–∞' : '–ü–æ–∫–∞–∑–∞—Ç—å: –Ω–µ—Ç';
                if (window.currentChartData) renderFinanceChart(window.currentChartData);
            };
            card.appendChild(title);
            card.appendChild(value);
            card.appendChild(toggle);
            grid.appendChild(card);
        });
    }

    function selectAllMetrics(enable) {
        if (!window.selectedMetrics) window.selectedMetrics = new Set();
        if (enable) {
            // –≤–∫–ª—é—á–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª—é—á–∏
            window.selectedMetrics = new Set(METRICS.map(m => m.key));
        } else {
            window.selectedMetrics.clear();
        }
        // –û–±–Ω–æ–≤–∏–º –∫–Ω–æ–ø–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
        const grid = document.getElementById('allMetricsGrid');
        const buttons = grid.querySelectorAll('button.range-btn');
        buttons.forEach((btn, idx) => {
            const m = METRICS[idx];
            const on = window.selectedMetrics.has(m.key);
            btn.classList.toggle('active', on);
            btn.textContent = on ? '–ü–æ–∫–∞–∑–∞—Ç—å: –¥–∞' : '–ü–æ–∫–∞–∑–∞—Ç—å: –Ω–µ—Ç';
        });
        if (window.currentChartData) renderFinanceChart(window.currentChartData);
    }

    // renderFinanceChart –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ static/script.js
    // AI –∞–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

    function formatNumber(num) {
        return new Intl.NumberFormat('ru-RU').format(Math.round(num));
    }

    // –õ–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö –º–µ–Ω—é
    document.addEventListener('click', function(e) {
        const userCustom = document.getElementById('userSelectCustom');
        const bizCustom = document.getElementById('businessSelectCustom');
        
        [userCustom, bizCustom].forEach((container, index) => {
            if (!container) return;
            
            const button = container.querySelector('.dropdown-button');
            const menu = container.querySelector('.dropdown-menu');
            
            if (!button || !menu) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –∏–º–µ–Ω–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ, –Ω–æ –Ω–µ –ø–æ –º–µ–Ω—é –≤–Ω—É—Ç—Ä–∏
            if (button.contains(e.target) && !menu.contains(e.target)) {
                container.classList.toggle('open');
            } else if (!container.contains(e.target)) {
                container.classList.remove('open');
            }
        });
    });

    function positionDropdownPortal(customSelect) {
        // –£–±–∏—Ä–∞–µ–º JavaScript –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ CSS
        // CSS —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –º–µ–Ω—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–æ–¥–∏—Ç–µ–ª—è
    }

    function closeCustomSelect(id) {
        const container = document.getElementById(id);
        if (container) container.classList.remove('open');
    }

    // Reposition dropdowns on window resize
    window.addEventListener('resize', function() {
        const userCustom = document.getElementById('userSelectCustom');
        const bizCustom = document.getElementById('businessSelectCustom');
        [userCustom, bizCustom].forEach(cs => {
            if (cs && cs.classList.contains('is-open')) {
                positionDropdownPortal(cs);
            }
        });
    });

    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    function exportChart(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            alert('–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        let hasContent = false;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–µ–ø—É—Å—Ç—ã–µ –ø–∏–∫—Å–µ–ª–∏ (–Ω–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ)
        for (let i = 3; i < data.length; i += 4) {
            if (data[i] > 0) { // alpha channel
                hasContent = true;
                break;
            }
        }
        
        if (!hasContent) {
            alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞');
            return;
        }
        
        const link = document.createElement('a');
        link.download = `chart-${canvasId}-${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }
</script>
{% endblock %}