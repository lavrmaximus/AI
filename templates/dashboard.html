{% extends "base.html" %}

{% block title %}Дашборд - BusinessAI{% endblock %}

{% block content %}
<div class="user-selector">
    <label for="userSelect">Выберите профиль:</label>
    <div class="enhanced-select">
        <select id="userSelect" onchange="loadUserData()">
            <option value="">Загрузка...</option>
        </select>
    </div>
</div>

<!-- KPI Cards -->
<div class="kpi-section">
    <h2>Ключевые метрики</h2>
    <div class="kpi-grid" id="kpiGrid">
        <div class="kpi-card">
            <h3>Выручка</h3>
            <div class="value" id="revenue-value">0 ₽</div>
            <div class="change" id="revenue-change">+0%</div>
        </div>
        <div class="kpi-card">
            <h3>Расходы</h3>
            <div class="value" id="expenses-value">0 ₽</div>
            <div class="change" id="expenses-change">+0%</div>
        </div>
        <div class="kpi-card">
            <h3>Прибыль</h3>
            <div class="value" id="profit-value">0 ₽</div>
            <div class="change" id="profit-change">+0%</div>
        </div>
        <div class="kpi-card">
            <h3>Клиенты</h3>
            <div class="value" id="clients-value">0</div>
            <div class="change" id="clients-change">+0%</div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-section">
    <div class="chart-container">
        <div class="chart-header">
            <h3>Финансовая динамика</h3>
            <div class="chart-actions">
                <div class="time-range">
                    <button class="range-btn" data-range="day" onclick="setTimeRange('day')">День</button>
                    <button class="range-btn" data-range="week" onclick="setTimeRange('week')">Неделя</button>
                    <button class="range-btn" data-range="month" onclick="setTimeRange('month')">Месяц</button>
                    <button class="range-btn" data-range="quarter" onclick="setTimeRange('quarter')">Квартал</button>
                    <button class="range-btn active" data-range="all" onclick="setTimeRange('all')">Все</button>
                </div>
            </div>
        </div>
        
        <div class="scrollable-chart-container chart-no-scroll">
            <div class="chart-wrapper">
                <canvas id="financeChart"></canvas>
                <div id="cursorLine" class="cursor-line" style="display:none;"></div>
            </div>
            <div id="chartReadout" class="chart-readout" aria-hidden="true"></div>
        </div>
    </div>
    
    <div class="metrics-container">
        <h3>Дополнительные метрики</h3>
        <div class="metrics-grid">
            <div class="metric-item">
                <span class="metric-label">Средний чек</span>
                <span class="metric-value" id="avg-check-value">0 ₽</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Рейтинг бизнеса</span>
                <span class="metric-value" id="rating-value">0/10</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Рентабельность</span>
                <span class="metric-value" id="profitability-value">0%</span>
            </div>
        </div>
    </div>
</div>





<script>
    // Глобальная переменная для хранения экземпляра графика
    let financeChart = null;

    // Загрузка списка пользователей при открытии страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
    });

    async function loadUsers() {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            
            if (data.success) {
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '<option value="">Выберите профиль</option>';
                
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    userSelect.appendChild(option);
                });
                
                // Автоматически выбираем первого профиля для демонстрации
                if (data.users.length > 0) {
                    userSelect.value = data.users[0].id;
                    loadUserData();
                }
            }
        } catch (error) {
            console.error('Ошибка загрузки пользователей:', error);
        }
    }

    async function loadUserData() {
        const userId = document.getElementById('userSelect').value;
        if (!userId) return;

        await loadKPIMetrics(userId);
        await loadFinanceData(userId);
    }

    async function loadKPIMetrics(userId) {
        try {
            const response = await fetch(`/api/user-kpi-metrics/${userId}`);
            const data = await response.json();
            
            if (data.success) {
                updateKPICards(data.kpi);
            }
        } catch (error) {
            console.error('Ошибка загрузки KPI:', error);
        }
    }

    async function loadFinanceData(userId) {
        try {
            const response = await fetch(`/api/user-finance-data/${userId}`);
            const data = await response.json();
            
            if (data.success) {
                renderFinanceChart(data.data);
                updateAdditionalMetrics(data.latest, data.data);
            }
        } catch (error) {
            console.error('Ошибка загрузки финансовых данных:', error);
        }
    }


    function updateKPICards(kpi) {
        updateKPICard('revenue', kpi.revenue, '₽');
        updateKPICard('expenses', kpi.expenses, '₽');
        updateKPICard('profit', kpi.profit, '₽');
        updateKPICard('clients', kpi.clients, '');
    }

    function updateKPICard(type, data, suffix) {
        const valueElement = document.getElementById(`${type}-value`);
        const changeElement = document.getElementById(`${type}-change`);
        
        valueElement.textContent = formatNumber(data.current) + (suffix ? ' ' + suffix : '');
        
        const change = data.change || 0;
        changeElement.textContent = (change > 0 ? '+' : '') + change + '%';
        changeElement.className = `change ${change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral'}`;
    }

    function updateAdditionalMetrics(latest, financeData) {
        if (latest) {
            document.getElementById('avg-check-value').textContent = 
                formatNumber(latest.average_check) + ' ₽';
            document.getElementById('rating-value').textContent = 
                (latest.rating || 0) + '/10';
            
            // Рассчитываем рентабельность
            if (financeData && financeData.revenue.length > 0) {
                const currentRevenue = financeData.revenue[0];
                const currentProfit = financeData.profit[0];
                const profitability = currentRevenue > 0 ? (currentProfit / currentRevenue * 100) : 0;
                document.getElementById('profitability-value').textContent = 
                    profitability.toFixed(1) + '%';
            }
        }
    }

    // renderFinanceChart используется из static/script.js
    // AI анализ перенесён на вкладку Аналитика

    function formatNumber(num) {
        return new Intl.NumberFormat('ru-RU').format(Math.round(num));
    }
</script>
{% endblock %}